<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPA Robotics - Admin Seguro</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #0f172a; color: #f8fafc; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        h1 { color: #38bdf8; text-transform: uppercase; font-size: 1.5rem; }
        
        .status-box { padding: 20px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; border: 1px solid #475569; }
        .status-waiting { background: #334155; color: #94a3b8; }
        .status-ready { background: #1e3a8a; color: #38bdf8; border: 2px solid #38bdf8; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 80%; font-size: 1.1em; text-align: center; margin-bottom: 10px; }
        .btn-ready { background: #38bdf8; color: #0f172a; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 80%; }
        
        /* BOTONES ADMIN OCULTOS */
        .admin-only { display: none; } 
        .btn-cancel { background: #f59e0b; color: #451a03; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-reset { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }

        .speed-display { font-size: 4.5em; color: #4ade80; margin: 10px 0; font-family: 'Courier New', monospace; font-weight: bold; }
        .unit { font-size: 0.3em; color: #94a3b8; }

        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .table-section { background: #0f172a; padding: 10px; border-radius: 12px; border: 1px solid #334155; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 0.8em; }
        th { background: #334155; color: #94a3b8; padding: 8px; }
        td { background: #1e293b; padding: 8px; border-top: 1px solid #334155; }
        .top-row-1 { border: 2px solid #fbbf24; color: #fbbf24; font-weight: bold; }
    </style>
</head>
<body onload="verificarAcceso()">

    <div class="container">
        <h1>üèéÔ∏è UPA ROBOTICS</h1>
        
        <div id="status-area" class="status-box status-waiting">
            <div id="input-view">
                <p id="label-nombre" style="margin:0 0 10px 0;">INGRESA NOMBRE DEL COMPETIDOR:</p>
                <input type="password" id="robot-input" placeholder="Escribe aqu√≠..." onkeydown="if(event.key==='Enter') procesarEntrada()">
                <button class="btn-ready" onclick="procesarEntrada()">ARMAR SISTEMA</button>
            </div>
            <div id="ready-view" style="display:none;">
                <p id="status-text">ESPERANDO DETECCI√ìN...</p>
                <button class="btn-cancel admin-only" onclick="cancelarNombre()">‚úñ CANCELAR REGISTRO</button>
            </div>
        </div>

        <div class="speed-display" id="speed-val">0.0 <span class="unit">mm/s</span></div>

        <div class="tables-grid">
            <div class="table-section">
                <h2 style="color:#fbbf24; font-size: 1em;">üèÜ TOP 10 R√âCORDS</h2>
                <table>
                    <thead><tr><th>Pos</th><th>Robot</th><th>mm/s</th></tr></thead>
                    <tbody id="top-10-table"></tbody>
                </table>
            </div>
            <div class="table-section">
                <h2 style="color:#38bdf8; font-size: 1em;">üïí HISTORIAL GLOBAL</h2>
                <table>
                    <thead><tr><th>Hora</th><th>Robot</th><th>mm/s</th></tr></thead>
                    <tbody id="history-table"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-panel" class="admin-only">
            <hr style="border: 1px dashed #ef4444; margin-top: 30px;">
            <p style="color:#ef4444; font-weight: bold;">MODO ADMINISTRADOR ACTIVO</p>
            <button class="btn-reset" onclick="borrarNube()">LIMPIAR TODA LA BASE DE DATOS</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDF00ZBgFz0yu-uogdLgP7G4Xp94cgNg-g",
            databaseURL: "https://cronometro-pista-618ad-default-rtdb.firebaseio.com",
            projectId: "cronometro-pista-618ad"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- SEGURIDAD ---
        const MASTER_KEY = "upa2026"; // Esta es tu clave
        let esAdmin = false;

        function verificarAcceso() {
            if (localStorage.getItem('admin_upa') === 'true') {
                activarModoAdmin();
            }
        }

        function activarModoAdmin() {
            esAdmin = true;
            localStorage.setItem('admin_upa', 'true');
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            const input = document.getElementById('robot-input');
            input.type = "text"; // Para el admin el input ya es visible
            document.getElementById('label-nombre').innerHTML = "MODO ADMIN: INGRESA NOMBRE";
            console.log("Acceso administrador concedido.");
        }

        function procesarEntrada() {
            const val = document.getElementById('robot-input').value.trim();
            if (!val) return;

            if (val === MASTER_KEY) {
                activarModoAdmin();
                document.getElementById('robot-input').value = "";
                alert("¬°Bienvenido, Administrador!");
                return;
            }

            // Registrar nombre en la nube para sincronizar todos los dispositivos
            db.ref('estado_actual').set({ armado: true, nombre: val });
            document.getElementById('robot-input').value = "";
        }

        // --- SINCRONIZACI√ìN ---
        db.ref('estado_actual').on('value', (snapshot) => {
            const estado = snapshot.val();
            const inputView = document.getElementById('input-view');
            const readyView = document.getElementById('ready-view');
            const statusArea = document.getElementById('status-area');

            if (estado && estado.armado) {
                inputView.style.display = "none";
                readyView.style.display = "block";
                statusArea.className = "status-box status-ready";
                document.getElementById('status-text').innerHTML = "LISTO: ESPERANDO A " + estado.nombre.toUpperCase();
                document.querySelector('.btn-cancel').style.display = esAdmin ? "inline-block" : "none";
            } else {
                inputView.style.display = "block";
                readyView.style.display = "none";
                statusArea.className = "status-box status-waiting";
            }
        });

        db.ref('historial').on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                document.getElementById('history-table').innerHTML = "";
                document.getElementById('top-10-table').innerHTML = "";
                return;
            }
            const lista = Object.values(data);
            
            // Historial
            const historyBody = document.getElementById('history-table');
            historyBody.innerHTML = "";
            lista.slice().reverse().forEach(item => {
                historyBody.insertAdjacentHTML('beforeend', `<tr><td>${item.time}</td><td>${item.name}</td><td>${item.speed.toFixed(2)}</td></tr>`);
            });

            // Top 10
            const topBody = document.getElementById('top-10-table');
            topBody.innerHTML = "";
            const top10 = lista.sort((a, b) => b.speed - a.speed).slice(0, 10);
            top10.forEach((item, i) => {
                const cls = i === 0 ? 'class="top-row-1"' : '';
                topBody.insertAdjacentHTML('beforeend', `<tr ${cls}><td>#${i+1}</td><td>${item.name}</td><td>${item.speed.toFixed(2)}</td></tr>`);
            });
        });

        // L√≥gica del sensor vinculada al estado armado
        db.ref('sector1/velocidad').on('value', (snapshot) => {
            const vel = snapshot.val();
            db.ref('estado_actual').once('value', (snap) => {
                const estado = snap.val();
                if (estado && estado.armado && vel > 0) {
                    const time = new Date().toLocaleTimeString();
                    document.getElementById('speed-val').innerHTML = vel.toFixed(2) + ' <span class="unit">mm/s</span>';
                    
                    db.ref('historial').push({ name: estado.nombre, speed: vel, time: time });
                    db.ref('estado_actual').set({ armado: false, nombre: "" });
                    db.ref('sector1/velocidad').set(0);
                }
            });
        });

        function cancelarNombre() {
            if (confirm("¬øCancelar el turno actual?")) {
                db.ref('estado_actual').set({ armado: false, nombre: "" });
            }
        }

        function borrarNube() {
            if (confirm("¬°ATENCI√ìN! Se borrar√° todo el historial global. ¬øContinuar?")) {
                db.ref('historial').remove();
                db.ref('estado_actual').set({ armado: false, nombre: "" });
            }
        }
    </script>
</body>
</html>
