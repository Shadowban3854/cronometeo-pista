<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPA Robotics - Sincronizaci√≥n Total</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #0f172a; color: #f8fafc; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: auto; background: #1e293b; padding: 20px; border-radius: 20px; border: 1px solid #334155; }
        h1 { color: #38bdf8; text-transform: uppercase; cursor: pointer; font-size: 1.5rem; }
        
        /* ESTADOS SINCRONIZADOS */
        .status-box { padding: 20px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; border: 1px solid #475569; }
        .status-waiting { background: #334155; color: #94a3b8; }
        .status-ready { background: #1e3a8a; color: #38bdf8; border: 2px solid #38bdf8; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        input { background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 80%; font-size: 1.1em; text-align: center; margin-bottom: 10px; }
        .btn-ready { background: #38bdf8; color: #0f172a; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 80%; }
        
        /* BOT√ìN CANCELAR NOMBRE (Solo Admin) */
        .btn-cancel { background: #f59e0b; color: #451a03; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 0.8em; font-weight: bold; display: none; }

        .speed-display { font-size: 4.5em; color: #4ade80; margin: 10px 0; font-family: 'Courier New', monospace; font-weight: bold; }
        .unit { font-size: 0.3em; color: #94a3b8; }

        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .table-section { background: #0f172a; padding: 10px; border-radius: 12px; border: 1px solid #334155; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 0.8em; }
        th { background: #334155; color: #94a3b8; padding: 8px; }
        td { background: #1e293b; padding: 8px; border-top: 1px solid #334155; }
        .top-row-1 { border: 2px solid #fbbf24; color: #fbbf24; font-weight: bold; }

        #admin-panel { margin-top: 30px; display: none; border-top: 2px dashed #ef4444; padding-top: 20px; }
        .btn-reset { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1 onclick="activarAdmin()">üèéÔ∏è UPA ROBOTICS</h1>
        
        <div id="status-area" class="status-box status-waiting">
            <div id="input-view">
                <p style="margin:0 0 10px 0;">NUEVO COMPETIDOR:</p>
                <input type="text" id="robot-input" placeholder="Nombre del Robot..." onkeydown="if(event.key==='Enter') armarSistema()">
                <button class="btn-ready" onclick="armarSistema()">REGISTRAR Y ESPERAR SENSOR</button>
            </div>
            <div id="ready-view" style="display:none;">
                <p id="status-text">ESPERANDO DETECCI√ìN...</p>
                <button id="cancel-btn" class="btn-cancel" onclick="cancelarNombre()">‚úñ CANCELAR / BORRAR NOMBRE</button>
            </div>
        </div>

        <div class="speed-display" id="speed-val">0.0 <span class="unit">mm/s</span></div>

        <div class="tables-grid">
            <div class="table-section">
                <h2 style="color:#fbbf24; font-size: 1em;">üèÜ TOP 10 R√âCORDS</h2>
                <table>
                    <thead><tr><th>Pos</th><th>Robot</th><th>mm/s</th></tr></thead>
                    <tbody id="top-10-table"></tbody>
                </table>
            </div>
            <div class="table-section">
                <h2 style="color:#38bdf8; font-size: 1em;">üïí HISTORIAL GLOBAL</h2>
                <table>
                    <thead><tr><th>Hora</th><th>Robot</th><th>mm/s</th></tr></thead>
                    <tbody id="history-table"></tbody>
                </table>
            </div>
        </div>

        <div id="admin-panel">
            <p style="color:#ef4444; font-size: 0.8em; font-weight: bold;">PANEL DE CONTROL MAESTRO</p>
            <button class="btn-reset" onclick="borrarNube()">LIMPIAR TODA LA BASE DE DATOS</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDF00ZBgFz0yu-uogdLgP7G4Xp94cgNg-g",
            databaseURL: "https://cronometro-pista-618ad-default-rtdb.firebaseio.com",
            projectId: "cronometro-pista-618ad"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let nombreSincronizado = "";
        let sistemaArmadoSincronizado = false;
        let esAdmin = false;

        // 1. SINCRONIZACI√ìN DEL ESTADO (Para que todos vean lo mismo)
        db.ref('estado_actual').on('value', (snapshot) => {
            const estado = snapshot.val();
            const inputView = document.getElementById('input-view');
            const readyView = document.getElementById('ready-view');
            const statusArea = document.getElementById('status-area');
            const cancelBtn = document.getElementById('cancel-btn');

            if (estado && estado.armado) {
                sistemaArmadoSincronizado = true;
                nombreSincronizado = estado.nombre;
                
                inputView.style.display = "none";
                readyView.style.display = "block";
                statusArea.className = "status-box status-ready";
                document.getElementById('status-text').innerHTML = "SISTEMA LISTO: " + nombreSincronizado.toUpperCase();
                
                // El bot√≥n de cancelar solo se muestra si activaste el modo admin
                cancelBtn.style.display = esAdmin ? "inline-block" : "none";
            } else {
                sistemaArmadoSincronizado = false;
                inputView.style.display = "block";
                readyView.style.display = "none";
                statusArea.className = "status-box status-waiting";
            }
        });

        // 2. SINCRONIZACI√ìN DE TABLAS
        db.ref('historial').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const lista = Object.values(data);
                const historyBody = document.getElementById('history-table');
                historyBody.innerHTML = "";
                lista.reverse().forEach(item => {
                    historyBody.insertAdjacentHTML('beforeend', `<tr><td>${item.time}</td><td>${item.name}</td><td>${item.speed.toFixed(2)}</td></tr>`);
                });

                const topBody = document.getElementById('top-10-table');
                topBody.innerHTML = "";
                const top10 = lista.sort((a, b) => b.speed - a.speed).slice(0, 10);
                top10.forEach((item, i) => {
                    const cls = i === 0 ? 'class="top-row-1"' : '';
                    topBody.insertAdjacentHTML('beforeend', `<tr ${cls}><td>#${i+1}</td><td>${item.name}</td><td>${item.speed.toFixed(2)}</td></tr>`);
                });
            } else {
                document.getElementById('history-table').innerHTML = "";
                document.getElementById('top-10-table').innerHTML = "";
            }
        });

        // 3. DETECCI√ìN DEL SENSOR (ESP32)
        db.ref('sector1/velocidad').on('value', (snapshot) => {
            const vel = snapshot.val();
            if (sistemaArmadoSincronizado && vel > 0) {
                const time = new Date().toLocaleTimeString();
                document.getElementById('speed-val').innerHTML = vel.toFixed(2) + ' <span class="unit">mm/s</span>';

                // Registrar en la nube
                db.ref('historial').push({ name: nombreSincronizado, speed: vel, time: time });
                
                // Desarmar sistema globalmente
                db.ref('estado_actual').set({ armado: false, nombre: "" });
                // Resetear el valor del sensor para la pr√≥xima
                db.ref('sector1/velocidad').set(0);
            }
        });

        function armarSistema() {
            const nombre = document.getElementById('robot-input').value.trim();
            if (!nombre) return alert("Ingresa un nombre");
            // Actualiza la nube: ahora todos los dispositivos sabr√°n que "nombre" est√° en pista
            db.ref('estado_actual').set({ armado: true, nombre: nombre });
            document.getElementById('robot-input').value = "";
        }

        function cancelarNombre() {
            if (confirm("¬øBorrar nombre actual y volver a espera?")) {
                db.ref('estado_actual').set({ armado: false, nombre: "" });
            }
        }

        let adminClicks = 0;
        function activarAdmin() {
            adminClicks++;
            if(adminClicks === 5) { 
                esAdmin = true;
                document.getElementById('admin-panel').style.display = "block";
                // Mostrar bot√≥n de cancelar si el sistema est√° armado
                if(sistemaArmadoSincronizado) document.getElementById('cancel-btn').style.display = "inline-block";
                alert("MODO ADMIN: ACTIVADO");
            }
        }

        function borrarNube() {
            if(confirm("ESTO BORRAR√Å TODO EL HISTORIAL PARA TODOS. ¬øContinuar?")) {
                db.ref('historial').remove();
                db.ref('estado_actual').set({ armado: false, nombre: "" });
                db.ref('sector1/velocidad').set(0);
                alert("Base de datos limpia");
            }
        }
    </script>
</body>
</html>
